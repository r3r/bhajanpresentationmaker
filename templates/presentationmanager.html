{% extends 'parent.html' %}

{% block body %}
<div class="row">
    <div class="col-md-12">
        <h3>Add, edit and sort Bhajans for the presentation</h3>
    </div>
</div>
<div class="row">
    <div class="col-md-12">
        <h4>Instructions</h4>
        <ul>
            <li>Add bhajans by either: </li>
            <ul>
                <li>Searching for the Bhajan at the end of the page and clicking on the bhajan id.</li>
                <li>Entering a Bhajan Id directly and clicking Add bhajan to list</li>
                <li>You can add a filler slide by clicking the Add a Filler Slide.</li>
            </ul>
            <li>Sort your bhajans by simply reordering them by dragging and dropping them</li>
            <li>Delete a chosen bhajan by clicking the little x by its id</li>
            <li>Edit the bhajan for this presentation by simply clicking on the Bhajan name and modifying the bhajan in the textarea below</li>
            <li>Enter the key for each Bhajan</li>
            <li>Click Generate Presentation</li>
        </ul>
    </div>
</div>
<div class="row">
    <div class="col-md-12">
        <form enctype="application/x-www-form-urlencoded" method="post"
              action="/presentationmanager/generate" class="form-horizontal" >
            <h3>Workspace</h3>
            <div class="form-group">
                <label for="title" class="col-sm-2 control-label">Presentation Title: </label>
                <div class="col-sm-10">
                    <input type="text" name="title" id="title" style="width:300px;" value="{{title}}"/>
                </div>
            </div>
            <div class="form-group">
                <label for="subtitle" class="col-sm-2 control-label">Presentation Sub-title: </label>
                <div class="col-sm-10">
                    <input type="text" name="subtitle" id="subtitle" value="{{subtitle}}"/>
                </div>
            </div>
            <table id="presentationIndex" class="table table-hover">
                <thead>
                <tr>
                    <th>Id</th>
                    <th>Bhajan Name</th>
                    <th>Key</th>
                </tr>
                </thead>
                <tbody id="sortable">

                </tbody>
            </table>
            <div class="row">
                <div class="col-md-4 col-md-offset-8">
                    <input type="submit" class="btn btn-primary" value="Generate Presentation"/>
                </div>
            </div>
        </form>
    </div>
</div>
<div class="row">
    <hr/>
    <div class="col-md-3">
        <input id="addFillerSlide" class="btn btn-primary" type="button" value="Add Filler Slide"/>
    </div>
    <div class="col-md-6">
        <input type="number" placeholder="Bhajan id to add" name="bhajan_to_add_id" id="bhajan_to_add_id"/>
        <input id="addBhajanBtn" class="btn btn-primary" type="button" value="Add bhajan to list"/>
    </div>
</div>

<div class="row">
    <hr/>
    <div class="col-md-3" id="demoDescription" style="display:none;">
        Please click on a Bhajan above to preview it and modify if necessary.
        You can add the following on a line of its own to specify the start of a new slide:
        [pagebreak]
    </div>
    <div class="col-md-6 demoHolder">
    </div>
</div>

<div class="row">
    <div class="col-md-12">
        <h3>Bhajans to choose from:</h3>
        <table id="index" class="table table-hover">
            <thead>
            <tr>
                <th>Id</th>
                <th>Bhajan Name</th>
            </tr>
            </thead>
            <tbody>
            {%- for bhajan in bhajans %}
            <tr>
                <td><a href="#" class="indexBhajanId"> {{ bhajan.id }} </a></td>
                <td>{{ bhajan.name }}</td>
            </tr>
            {%- endfor %}
            </tbody>
        </table>
    </div>
</div>
<script type="text/javascript" src="{{ url_for('static', filename='js/jquery-ui.min.js') }}"></script>

<script type="text/javascript">
    $.fn.mirror = function (selector) {
        return this.each(function () {
            var $this = $(this);
            var $selector = $(selector);
            $this.bind('keyup', function () {
                $selector.val(($this.val()));
            });
        });
    };
    $('#addBhajanBtn').click(function() {
        fetchBhajan($('#bhajan_to_add_id').val());
        return false;
    });
    $( function() {
        $( "#sortable" ).sortable();
    });
    $(function () {
        $('#index').DataTable();
    });
    $('.indexBhajanId').click(function() {
         fetchBhajan($(this).html());
         return false;
    });
    $('#addFillerSlide').click(function() {
        fetchBhajan("-1");
        return false;
    });
    function fetchBhajan(bhajanId) {
        var url = "/bhajanmanager/bhajanjson/"+ bhajanId;
         $.get(url, function(data) {
            if (Object.keys(data).length === 0) {
                alert("No Bhajan with that id: " + bhajanId);
            } else {
                title = data['name']
                id = data['id']
                bhajan = data['bhajan']
                deleteLink = '<a class="deleteLink" href="#"><span \
                            class="glyphicon glyphicon-remove" \
                            aria-hidden="true"></span></a>';
                if (id == "-1") {
                    // filler slide
                    html = "<tr> <td>" + deleteLink + "</td> \
                    <td> Filler slide </td> \
                    <input type='hidden' value='' name='bhajan_id' id='bhajan_id'/> \
                    <input type='hidden' value='' name='bhajan' id='bhajan'/> \
                    <td><input type='hidden' name='key' value=''/> </td> </tr>";
                    $('#presentationIndex > tbody:last-child').append(html)
                    tr = $('#presentationIndex > tbody:last-child tr').last()
                    tr.find('#bhajan_id').val(id)
                } else {
                    html = "<tr><td>" + deleteLink + "</td> \
                    <td class='properBhajan'><input type='text' id='title' name='title' href='#'></a><a id='bhajanEdit' href='#'> \
                                        <span class='glyphicon glyphicon-edit' aria-hidden='true'></span></a></td> \
                    <input type='hidden' value='' name='bhajan_id' id='bhajan_id'/> \
                    <input type='hidden' value='' name='bhajan' id='bhajan'/> \
                    <td><input type='text' name='key' /> </td> </tr>";
                    $('#presentationIndex > tbody:last-child').append(html)
                    tr = $('#presentationIndex > tbody:last-child tr').last()
                    tr.find('td').first().prepend(id + " ")
                    tr.find('#title').val(title)
                    tr.find('#bhajan_id').val(id)
                    tr.find('#bhajan').val(bhajan)
                }
                tr.find(".deleteLink").one("click", function() {
                    // this is bad, this adds the listener to all previously present items as well
                    var tr = $(this).closest('tr');
                    tr.css("background-color","#FF3700");
                    tr.fadeOut(400, function(){
                        tr.remove();
                    });
                    return false;
                });
                $(".properBhajan a#bhajanEdit").click(function() {
                    $('#demoDescription').css('display', 'block');
                    var tr = $(this).closest('tr');
                    var bhajan_hidden = tr.find('input[id="bhajan"]');
                    var bhajan_id = tr.find('input[id="bhajan_id"]');
                    var demoId = "demo"+bhajan_id.val();
                    var newDemo = "Currently Selected Bhajan: <br/><textarea  class='form-control' rows='11' cols='50' id='"+demoId+"'>"+bhajan_hidden.val()+"</textarea>";
                    $('.demoHolder').html(newDemo);
                    $("#"+demoId).mirror(bhajan_hidden);
                    return false;
                });
            }
        });
    }
</script>

{% endblock %}